name: integration tests
on: [push]
jobs:
  android-integration-test:
    name: run integration test on Android emulator
    runs-on: macos-latest
    strategy:
      matrix:
        device:
          - "pixel_xl"
      fail-fast: false
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v1
        with:
          java-version: '8.x'
      - uses: subosito/flutter-action@v1.5.3
        with:
          flutter-version: '2.2.0'
      - name: run tests
        timeout-minutes: 30
        uses: reactivecircus/android-emulator-runner@v2.15.0
        env:
          ANDROID_HOME: '/Users/runner/Library/Android/sdk'
          ANDROID_SDK_ROOT: '/Users/runner/Library/Android/sdk'
        with:
          api-level: 29
          profile: ${{ matrix.device }}
          script: |
            /Users/runner/Library/Android/sdk/tools/bin/avdmanager list
            sleep 20
            ./scripts/setenv.sh
            flutter doctor -v
            flutter pub get && flutter drive --target=test_driver/app.dart --no-sound-null-safety
